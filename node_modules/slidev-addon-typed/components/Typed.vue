<template>
  <div ref="typedElement" class="typed-text"></div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, watch } from 'vue';
import { default as TypedJS } from 'typed.js';

interface Props {
  strings?: string[];
  typeSpeed?: number;
  backSpeed?: number;
  backDelay?: number;
  startDelay?: number;
  fadeOut?: boolean;
  fadeOutClass?: string;
  fadeOutDelay?: number;
  loop?: boolean;
  loopCount?: number;
  showCursor?: boolean;
  cursorChar?: string;
  autoInsertCss?: boolean;
  attr?: string;
  bindInputFocusEvents?: boolean;
  contentType?: 'html' | 'null';
  shuffle?: boolean;
  smartBackspace?: boolean;
  preStringTyped?: () => void;
  onStringTyped?: () => void;
  onLastStringBackspaced?: () => void;
  onTypingPaused?: () => void;
  onTypingResumed?: () => void;
  onReset?: () => void;
  onStop?: () => void;
  onStart?: () => void;
  onDestroy?: () => void;
}

const props = withDefaults(defineProps<Props>(), {
  strings: () => ['Hello World!'],
  typeSpeed: 70,
  backSpeed: 50,
  backDelay: 2000,
  startDelay: 0,
  fadeOut: false,
  fadeOutClass: 'typed-fade-out',
  fadeOutDelay: 500,
  loop: false,
  loopCount: Infinity,
  showCursor: true,
  cursorChar: '|',
  autoInsertCss: true,
  attr: undefined,
  bindInputFocusEvents: false,
  contentType: 'html',
  shuffle: false,
  smartBackspace: true,
});

const typedElement = ref<HTMLElement | null>(null);
let typedInstance: TypedJS | null = null;

const initTyped = () => {
  if (!typedElement.value) return;

  const options: any = {
    strings: props.strings,
    typeSpeed: props.typeSpeed,
    backSpeed: props.backSpeed,
    backDelay: props.backDelay,
    startDelay: props.startDelay,
    fadeOut: props.fadeOut,
    fadeOutClass: props.fadeOutClass,
    fadeOutDelay: props.fadeOutDelay,
    loop: props.loop,
    loopCount: props.loopCount,
    showCursor: props.showCursor,
    cursorChar: props.cursorChar,
    autoInsertCss: props.autoInsertCss,
    attr: props.attr,
    bindInputFocusEvents: props.bindInputFocusEvents,
    contentType: props.contentType,
    shuffle: props.shuffle,
    smartBackspace: props.smartBackspace,
  };

  // Add callback functions if provided
  if (props.preStringTyped) options.preStringTyped = props.preStringTyped;
  if (props.onStringTyped) options.onStringTyped = props.onStringTyped;
  if (props.onLastStringBackspaced) options.onLastStringBackspaced = props.onLastStringBackspaced;
  if (props.onTypingPaused) options.onTypingPaused = props.onTypingPaused;
  if (props.onTypingResumed) options.onTypingResumed = props.onTypingResumed;
  if (props.onReset) options.onReset = props.onReset;
  if (props.onStop) options.onStop = props.onStop;
  if (props.onStart) options.onStart = props.onStart;
  if (props.onDestroy) options.onDestroy = props.onDestroy;

  typedInstance = new TypedJS(typedElement.value, options);
};

const destroyTyped = () => {
  if (typedInstance) {
    typedInstance.destroy();
    typedInstance = null;
  }
};

onMounted(() => {
  initTyped();
});

onBeforeUnmount(() => {
  destroyTyped();
});

// Watch for prop changes and reinitialize
watch(
  () => props.strings,
  () => {
    destroyTyped();
    initTyped();
  },
  { deep: true }
);

// Expose methods for manual control
defineExpose({
  start: () => typedInstance?.start(),
  stop: () => typedInstance?.stop(),
  toggle: () => typedInstance?.toggle(),
  reset: () => typedInstance?.reset(),
  destroy: () => destroyTyped(),
});
</script>

<style>
/* Let Typed.js handle the cursor naturally - minimal intervention */
.typed-cursor {
  animation: typedjsBlink 0.7s infinite;
}

@keyframes typedjsBlink {
  50% { opacity: 0.0; }
}

@-webkit-keyframes typedjsBlink {
  0% { opacity: 1; }
  50% { opacity: 0.0; }
  100% { opacity: 1; }
}

.typed-fade-out {
  opacity: 0;
  transition: opacity 0.25s;
}

.typed-text {
  white-space: pre-wrap;
  display: inline-block;
  vertical-align: middle;
  margin-right: .1rem;
}

.typed-text .typed-cursor {
  vertical-align: baseline;
}
</style>